<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaLyzer Ultimate - Deep Metadata Forensics</title>
    
    <script src="https://unpkg.com/exifreader@4.23.0/dist/exif-reader.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --accent: #2563eb;
            --border: #e5e7eb;
            --code-bg: #f9fafb;
            --status-ok: #10b981;
            --status-err: #ef4444;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f3f4f6;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --border: #334155;
            --code-bg: #0f172a;
        }

        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; min-height: 100vh; }
        
        /* HEADER */
        header { background: var(--card-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
        .controls { display: flex; gap: 15px; align-items: center; }
        
        /* LIBRARY STATUS INDICATOR */
        .lib-status { font-size: 0.8rem; font-weight: bold; padding: 4px 10px; border-radius: 99px; background: #eee; color: #666; }
        .lib-status.ok { background: #d1fae5; color: #065f46; }
        .lib-status.err { background: #fee2e2; color: #991b1b; }

        .theme-btn { background: none; border: 1px solid var(--border); color: var(--text-main); padding: 5px 15px; border-radius: 20px; cursor: pointer; }

        /* MAIN LAYOUT */
        main { max-width: 1200px; margin: 2rem auto; width: 100%; padding: 0 1rem; flex: 1; }

        /* DROP ZONE */
        .drop-zone { background: var(--card-bg); border: 2px dashed var(--border); border-radius: 1rem; padding: 4rem 2rem; text-align: center; cursor: pointer; }
        .drop-zone:hover { border-color: var(--accent); background: rgba(37, 99, 235, 0.04); }
        
        /* DASHBOARD */
        .dashboard { display: none; gap: 1.5rem; flex-wrap: wrap; }
        .sidebar { flex: 1; min-width: 300px; }
        .data-panel { flex: 3; min-width: 300px; background: var(--card-bg); border-radius: 1rem; border: 1px solid var(--border); overflow: hidden; }

        .thumbnail-box { width: 100%; min-height: 200px; background: var(--code-bg); display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid var(--border); }
        .thumbnail-box img { max-width: 100%; height: auto; max-height: 300px; }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem; }
        .btn { padding: 0.6rem; border-radius: 0.5rem; cursor: pointer; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-main); }
        .btn:hover { border-color: var(--accent); background: var(--code-bg); }

        /* TABLE */
        .panel-header { padding: 1rem; border-bottom: 1px solid var(--border); background: var(--code-bg); display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); word-break: break-word; }
        th { width: 30%; color: var(--accent); font-family: monospace; }
        td { font-family: monospace; }
        .group-header th { background: #e0e7ff; color: #3730a3; text-transform: uppercase; font-size: 0.75rem; text-align: center; }

        footer { text-align: center; padding: 2rem; border-top: 1px solid var(--border); margin-top: auto; opacity: 0.7; }
    </style>
</head>
<body>

    <header>
        <div class="brand">MetaLyzer <span>ULTIMATE</span></div>
        <div class="controls">
            <div id="libStatus" class="lib-status">Checking Libraries...</div>
            <button id="themeToggle" class="theme-btn">üåô</button>
        </div>
    </header>

    <main>
        <div class="drop-zone" id="dropZone">
            <h2>Drop file to Unlock Data</h2>
            <p style="opacity: 0.6">Images (JPG/PNG/TIFF), Videos, PDFs</p>
            <button class="btn" style="background: var(--accent); color: white; border: none; margin-top: 10px;">Select File</button>
            <input type="file" id="fileInput" style="display: none;">
        </div>

        <div id="errorBox" style="display:none; color: white; background: #ef4444; padding: 1rem; border-radius: 8px; margin-bottom: 20px; text-align: center;"></div>

        <div class="dashboard" id="dashboard">
            <div class="sidebar">
                <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border);">
                    <div class="thumbnail-box" id="thumbBox">No Preview</div>
                    <div><strong>Name:</strong> <span id="fileName">-</span></div>
                    <div><strong>Size:</strong> <span id="fileSize">-</span></div>
                    <div class="actions">
                        <button class="btn" onclick="downloadJSON()">{} JSON</button>
                        <button class="btn" onclick="downloadCSV()">üìä CSV</button>
                        <button class="btn" onclick="downloadTXT()">üìù TXT</button>
                        <button class="btn" onclick="downloadPDF()">üìÑ PDF</button>
                    </div>
                </div>
            </div>

            <div class="data-panel">
                <div class="panel-header">
                    <strong>Metadata Inspector</strong>
                    <input type="text" id="search" placeholder="Filter..." style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                </div>
                <div style="overflow-x: auto;">
                    <table id="metaTable"></table>
                </div>
            </div>
        </div>
    </main>

    <footer>Made By Aryan Giri</footer>

    <script>
        // --- 1. SYSTEM CHECK ---
        window.addEventListener('load', () => {
            const status = document.getElementById('libStatus');
            if (typeof window.ExifReader !== 'undefined') {
                status.innerText = "‚úì System Ready";
                status.classList.add('ok');
            } else {
                status.innerText = "‚ö† Library Error";
                status.classList.add('err');
                showError("Could not load ExifReader library. Please check your internet connection or disable ad-blockers.");
            }
        });

        // --- 2. THEME ---
        const themeBtn = document.getElementById('themeToggle');
        if(localStorage.getItem('theme')==='dark') document.body.setAttribute('data-theme', 'dark');
        themeBtn.onclick = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        };

        // --- 3. FILE HANDLING ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        let currentFile = null;
        let allTags = {};

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; };
        dropZone.ondragleave = () => dropZone.style.borderColor = 'var(--border)';
        dropZone.ondrop = e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };
        fileInput.onchange = e => handleFile(e.target.files[0]);

        async function handleFile(file) {
            if(!file) return;
            currentFile = file;
            
            // UI Reset
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
            dropZone.style.display = 'none';
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileSize').innerText = (file.size / 1024).toFixed(2) + ' KB';
            document.getElementById('metaTable').innerHTML = '<tr><td colspan="2">Scanning...</td></tr>';
            
            try {
                if (typeof ExifReader === 'undefined') throw new Error("ExifReader library not loaded.");

                // THE MAGIC LINE: expanded: true gives us the deep data
                const tags = await ExifReader.load(file, { expanded: true });
                allTags = tags;
                
                renderTable(tags);
                renderThumbnail(tags);

            } catch (err) {
                console.error(err);
                showError(err.message);
                document.getElementById('metaTable').innerHTML = '<tr><td colspan="2">Scan Failed.</td></tr>';
            }
        }

        function showError(msg) {
            const box = document.getElementById('errorBox');
            box.style.display = 'block';
            box.innerText = "Error: " + msg;
        }

        // --- 4. RENDERERS ---
        function renderTable(tags) {
            const table = document.getElementById('metaTable');
            table.innerHTML = '';
            
            // Prioritize specific groups
            const groups = Object.keys(tags).sort();
            
            if(groups.length === 0) {
                table.innerHTML = '<tr><td colspan="2">No metadata found in this file.</td></tr>';
                return;
            }

            groups.forEach(group => {
                if(group === 'thumbnail') return; // Handled separately
                
                // Group Header
                const hRow = document.createElement('tr');
                hRow.className = 'group-header';
                hRow.innerHTML = `<th colspan="2">${group}</th>`;
                table.appendChild(hRow);

                // Group Rows
                for(let key in tags[group]) {
                    let val = tags[group][key].description || tags[group][key].value;
                    if(Array.isArray(val)) val = val.join(', ');
                    if(typeof val === 'object') val = JSON.stringify(val); // Safety for nested objects
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `<th>${key}</th><td>${val}</td>`;
                    table.appendChild(row);
                }
            });
        }

        function renderThumbnail(tags) {
            const box = document.getElementById('thumbBox');
            box.innerHTML = '';
            
            if(tags.thumbnail) {
                const img = document.createElement('img');
                img.src = tags.thumbnail; // ExifReader returns base64 url
                box.appendChild(img);
            } else if (currentFile.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(currentFile);
                box.appendChild(img);
            } else {
                box.innerText = "No Preview";
            }
        }

        // --- 5. SEARCH ---
        document.getElementById('search').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#metaTable tr:not(.group-header)');
            rows.forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
            });
        });

        // --- 6. EXPORTS ---
        function downloadJSON() {
            save(JSON.stringify(allTags, null, 2), 'metadata.json', 'text/json');
        }
        
        function downloadCSV() {
            let csv = "Group,Tag,Value\n";
            for(let g in allTags) {
                if(g === 'thumbnail') continue;
                for(let k in allTags[g]) {
                    let v = allTags[g][k].description || allTags[g][k].value;
                    csv += `"${g}","${k}","${String(v).replace(/"/g, '""')}"\n`;
                }
            }
            save(csv, 'metadata.csv', 'text/csv');
        }

        function downloadTXT() {
            let txt = `REPORT: ${currentFile.name}\n\n`;
            for(let g in allTags) {
                if(g === 'thumbnail') continue;
                txt += `[${g.toUpperCase()}]\n`;
                for(let k in allTags[g]) {
                    let v = allTags[g][k].description || allTags[g][k].value;
                    txt += `  ${k}: ${v}\n`;
                }
                txt += "\n";
            }
            save(txt, 'metadata.txt', 'text/plain');
        }

        function downloadPDF() {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             
             let bodyData = [];
             for(let g in allTags) {
                if(g==='thumbnail') continue;
                for(let k in allTags[g]) {
                    let v = String(allTags[g][k].description || allTags[g][k].value);
                    bodyData.push([g, k, v.substring(0, 60)]);
                }
             }

             doc.text("MetaLyzer Report", 14, 20);
             doc.setFontSize(10);
             doc.text(`File: ${currentFile.name}`, 14, 28);
             
             doc.autoTable({
                 startY: 35,
                 head: [['Group', 'Tag', 'Value']],
                 body: bodyData,
                 theme: 'grid'
             });
             
             doc.save('metadata.pdf');
        }

        function save(content, name, type) {
            const blob = new Blob([content], {type: type});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = name; a.click();
        }
    </script>
</body>
</html>
