<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaLyzer Fortress - Unblockable</title>
    
    <style>
        :root {
            --bg: #111827;
            --card: #1f2937;
            --text: #f3f4f6;
            --accent: #3b82f6;
            --border: #374151;
            --ok: #10b981;
            --err: #ef4444;
        }

        body { font-family: system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        header { padding: 15px 25px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 900; color: var(--accent); letter-spacing: -0.5px; font-size: 1.2rem; }
        .status { font-size: 0.8rem; font-family: monospace; }
        .status.ok { color: var(--ok); }
        .status.err { color: var(--err); }

        /* MAIN */
        main { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        
        /* DROP ZONES */
        .zone-container { position: relative; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        
        .box {
            border: 2px dashed var(--border); border-radius: 12px;
            background: rgba(255,255,255,0.02);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center; transition: 0.2s;
            cursor: pointer; margin: 0 auto; max-width: 600px; width: 100%;
        }
        .box:hover { border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
        .box h2 { margin-top: 0; }
        
        /* MANUAL LOADER UI */
        #manualLoadUI { display: none; border-color: var(--err); background: rgba(239, 68, 68, 0.05); }
        #manualLoadUI h2 { color: var(--err); }
        .download-link { color: var(--accent); text-decoration: underline; cursor: pointer; }

        /* DASHBOARD (Results) */
        #dashboard { display: none; height: 100%; gap: 20px; }
        .sidebar { width: 300px; display: flex; flex-direction: column; gap: 15px; }
        .preview { background: #000; border-radius: 8px; border: 1px solid var(--border); height: 200px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .preview img { max-width: 100%; max-height: 100%; }
        
        .data-area { flex: 1; background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        .search-bar { padding: 15px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .search-bar input { width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        
        .table-scroll { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--accent); font-family: monospace; width: 35%; }
        td { font-family: monospace; word-break: break-all; }
        
        .btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn:hover { opacity: 0.9; }
        .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text); margin-top: 5px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">MetaLyzer üõ°Ô∏è <span style="font-size:0.8em; opacity:0.7">Fortress</span></div>
        <div id="statusIndicator" class="status">Initializing...</div>
    </header>

    <main>
        <div class="zone-container">
            
            <div id="fileBox" class="box" style="display:none;">
                <h2>üìÇ Analyze File</h2>
                <p>Drag & Drop Image, Video, or PDF</p>
                <button class="btn" style="width: auto; padding: 8px 24px; margin-top: 10px;">Browse Files</button>
            </div>

            <div id="manualLoadUI" class="box">
                <h2>‚ö†Ô∏è Network Blocked</h2>
                <p>Your network blocked the automatic library download.</p>
                <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin:15px 0; text-align:left; font-size:0.9rem;">
                    <strong>The Fix:</strong><br>
                    1. <a href="https://cdn.jsdelivr.net/npm/exifreader@4.23.0/dist/exif-reader.min.js" target="_blank" class="download-link">Click here</a> to download <code>exif-reader.min.js</code><br>
                    2. Drag that downloaded file into this box.
                </div>
                <div style="border: 2px dashed #666; padding: 20px; width: 100%; border-radius: 8px; margin-top: 10px;">
                    ‚¨áÔ∏è Drop <b>exif-reader.min.js</b> here to Start
                </div>
            </div>

            <input type="file" id="hiddenInput" style="display:none">
        </div>

        <div id="dashboard">
            <div class="sidebar">
                <div class="preview" id="thumbBox">No Preview</div>
                <div style="padding: 10px; background: var(--card); border-radius: 8px; border: 1px solid var(--border);">
                    <div id="fileName" style="font-weight:bold; margin-bottom:5px;">-</div>
                    <div id="fileSize" style="font-size:0.8rem; color:#888;">-</div>
                </div>
                <button class="btn" onclick="exportTXT()">Download Report</button>
                <button class="btn btn-sec" onclick="location.reload()">Reset</button>
            </div>
            <div class="data-area">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search metadata tags...">
                </div>
                <div class="table-scroll">
                    <table id="metaTable"></table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIG ---
        const UI = {
            status: document.getElementById('statusIndicator'),
            fileBox: document.getElementById('fileBox'),
            manualBox: document.getElementById('manualLoadUI'),
            input: document.getElementById('hiddenInput'),
            dash: document.getElementById('dashboard'),
            table: document.getElementById('metaTable'),
            thumb: document.getElementById('thumbBox')
        };
        
        let ExifReaderEngine = null;
        let currentFileData = {};

        // --- 1. RESILIENT LOADER ---
        async function init() {
            // Try explicit global check first
            if(window.ExifReader) { activateTool(); return; }

            const mirrors = [
                "https://cdn.jsdelivr.net/npm/exifreader@4.23.0/dist/exif-reader.min.js", // Standard
                "https://unpkg.com/exifreader@4.23.0/dist/exif-reader.min.js",             // Fallback 1
                "https://esm.sh/exifreader@4.23.0",                                         // Fallback 2 (Modern)
                "https://cdnjs.cloudflare.com/ajax/libs/exifreader/4.12.0/exif-reader.min.js" // Fallback 3 (Older)
            ];

            let loaded = false;
            for (const url of mirrors) {
                UI.status.innerText = `Trying: ${new URL(url).hostname}...`;
                try {
                    await loadScript(url);
                    if(window.ExifReader) {
                        loaded = true;
                        break;
                    }
                } catch(e) { console.log("Failed: " + url); }
            }

            if(loaded) {
                activateTool();
            } else {
                UI.status.innerText = "‚ö†Ô∏è Auto-Load Failed";
                UI.status.className = "status err";
                UI.manualBox.style.display = 'flex'; // Show Manual Loader
                setupManualLoader();
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        function activateTool() {
            UI.status.innerText = "‚óè System Ready";
            UI.status.className = "status ok";
            UI.manualBox.style.display = 'none';
            UI.fileBox.style.display = 'flex';
            ExifReaderEngine = window.ExifReader;
            setupFileHandlers();
        }

        // --- 2. MANUAL LOADER LOGIC ---
        function setupManualLoader() {
            // Drag & Drop for the library file itself
            UI.manualBox.addEventListener('dragover', e => { e.preventDefault(); UI.manualBox.style.borderColor = '#fff'; });
            UI.manualBox.addEventListener('dragleave', e => { UI.manualBox.style.borderColor = '#ef4444'; });
            UI.manualBox.addEventListener('drop', e => {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if(file && file.name.endsWith('.js')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            // Inject the dropped code
                            const script = document.createElement('script');
                            script.innerHTML = e.target.result;
                            document.head.appendChild(script);
                            
                            setTimeout(() => {
                                if(window.ExifReader) {
                                    activateTool();
                                } else {
                                    alert("Loaded file, but ExifReader not found. Are you sure you downloaded 'exif-reader.js'?");
                                }
                            }, 100);
                        } catch(err) { alert("Error parsing script: " + err.message); }
                    };
                    reader.readAsText(file);
                } else {
                    alert("Please drop the 'exif-reader.min.js' file.");
                }
            });
        }

        // --- 3. MAIN TOOL LOGIC ---
        function setupFileHandlers() {
            // Click to browse
            UI.fileBox.onclick = () => UI.input.click();
            UI.input.onchange = e => processFile(e.target.files[0]);

            // Drag & Drop
            UI.fileBox.ondragover = e => { e.preventDefault(); UI.fileBox.style.borderColor = 'var(--accent)'; };
            UI.fileBox.ondragleave = () => UI.fileBox.style.borderColor = 'var(--border)';
            UI.fileBox.ondrop = e => { 
                e.preventDefault(); 
                UI.fileBox.style.borderColor = 'var(--border)';
                processFile(e.dataTransfer.files[0]); 
            };
        }

        async function processFile(file) {
            if(!file) return;
            
            // Switch UI
            document.querySelector('.zone-container').style.display = 'none';
            UI.dash.style.display = 'flex';
            
            // Basic Info
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileSize').innerText = (file.size / 1024).toFixed(2) + " KB";
            UI.table.innerHTML = `<tr><td colspan="2">Analyzing binary data...</td></tr>`;

            try {
                // ENGINE RUN
                const tags = await ExifReaderEngine.load(file, { expanded: true });
                currentFileData = tags;
                renderTable(tags);
                renderThumb(tags, file);
            } catch (err) {
                UI.table.innerHTML = `<tr><td colspan="2" style="color:var(--err)">Error: ${err.message}</td></tr>`;
            }
        }

        function renderTable(tags) {
            UI.table.innerHTML = '';
            const groups = Object.keys(tags).sort();
            
            if(groups.length === 0) {
                 UI.table.innerHTML = '<tr><td colspan="2">No Metadata Found</td></tr>';
                 return;
            }

            for(const group of groups) {
                if(group === 'thumbnail') continue;

                // Group Header
                const h = document.createElement('tr');
                h.innerHTML = `<th colspan="2" style="background:#111; color:#fff; text-align:center">${group.toUpperCase()}</th>`;
                UI.table.appendChild(h);

                for(const key in tags[group]) {
                    let val = tags[group][key].description || tags[group][key].value;
                    if(Array.isArray(val)) val = val.join(', ');
                    if(typeof val === 'object') val = JSON.stringify(val);
                    
                    const r = document.createElement('tr');
                    r.innerHTML = `<th>${key}</th><td>${String(val).substring(0,200)}</td>`;
                    UI.table.appendChild(r);
                }
            }
        }

        function renderThumb(tags, file) {
            UI.thumb.innerHTML = '';
            if(tags.thumbnail) {
                const img = document.createElement('img');
                img.src = tags.thumbnail; // Base64 from ExifReader
                UI.thumb.appendChild(img);
            } else if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                UI.thumb.appendChild(img);
            } else {
                UI.thumb.innerText = "No Preview";
            }
        }

        // --- 4. EXPORT ---
        function exportTXT() {
            let txt = "METALYZER REPORT\n================\n";
            for(let g in currentFileData) {
                if(g === 'thumbnail') continue;
                txt += `\n[${g}]\n`;
                for(let k in currentFileData[g]) {
                    let v = currentFileData[g][k].description || currentFileData[g][k].value;
                    txt += `${k}: ${v}\n`;
                }
            }
            const blob = new Blob([txt], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'report.txt'; a.click();
        }

        // Search Filter
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#metaTable tr');
            rows.forEach(r => {
                if(r.querySelector('th') && r.querySelector('td')) { // Data rows
                    const txt = r.innerText.toLowerCase();
                    r.style.display = txt.includes(term) ? '' : 'none';
                }
            });
        });

        // Start
        init();

    </script>
</body>
</html>
