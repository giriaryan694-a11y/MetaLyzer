<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaLyzer Ultimate - Resilient Edition</title>
    
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --accent: #2563eb;
            --border: #e5e7eb;
            --status-ok: #10b981;
            --status-warn: #f59e0b;
            --status-err: #ef4444;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f3f4f6;
            --accent: #3b82f6;
            --border: #334155;
        }

        body { font-family: sans-serif; margin: 0; background: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; min-height: 100vh; }
        
        /* HEADER */
        header { background: var(--card-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
        
        /* LOADER STATUS */
        .loader-log { font-size: 0.75rem; font-family: monospace; color: var(--text-main); opacity: 0.7; text-align: right; }
        .status-dot { height: 10px; width: 10px; background: #ccc; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.ok { background: var(--status-ok); box-shadow: 0 0 5px var(--status-ok); }
        .status-dot.err { background: var(--status-err); }

        /* MAIN */
        main { max-width: 1200px; margin: 2rem auto; width: 100%; padding: 0 1rem; flex: 1; }
        .drop-zone { background: var(--card-bg); border: 2px dashed var(--border); border-radius: 1rem; padding: 4rem 2rem; text-align: center; cursor: pointer; transition: 0.2s; }
        .drop-zone:hover { border-color: var(--accent); background: rgba(37, 99, 235, 0.04); }

        /* DASHBOARD */
        .dashboard { display: none; gap: 1.5rem; flex-wrap: wrap; margin-top: 20px; }
        .sidebar { flex: 1; min-width: 250px; }
        .data-panel { flex: 3; min-width: 300px; background: var(--card-bg); border-radius: 1rem; border: 1px solid var(--border); overflow: hidden; }

        .thumbnail-box { width: 100%; min-height: 200px; background: rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid var(--border); overflow: hidden; }
        .thumbnail-box img { max-width: 100%; max-height: 300px; }

        .btn { padding: 0.6rem; border-radius: 0.5rem; cursor: pointer; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-main); width: 100%; margin-bottom: 5px; }
        .btn:hover { border-color: var(--accent); }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); word-break: break-all; }
        th { width: 30%; color: var(--accent); font-family: monospace; }
        .group-header th { background: rgba(37, 99, 235, 0.1); color: var(--accent); text-align: center; font-size: 0.8rem; text-transform: uppercase; }

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; }
        .log-line { margin: 2px 0; font-family: monospace; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <h2>Initializing MetaLyzer...</h2>
        <div id="loadLogs"></div>
        <button id="forceStartBtn" style="display:none; margin-top: 20px; padding: 10px 20px; cursor: pointer;">Force Start (Libraries might be missing)</button>
    </div>

    <header>
        <div class="brand">MetaLyzer <span>RESILIENT</span></div>
        <div class="loader-log">
            <span id="systemStatus" class="status-dot"></span> <span id="systemText">System Check...</span>
        </div>
    </header>

    <main>
        <div class="drop-zone" id="dropZone">
            <h2>Drop file here</h2>
            <p>Bypassing network blocks & scanning metadata</p>
            <input type="file" id="fileInput" style="display: none;">
        </div>

        <div class="dashboard" id="dashboard">
            <div class="sidebar">
                <div style="background: var(--card-bg); padding: 1rem; border-radius: 1rem; border: 1px solid var(--border);">
                    <div class="thumbnail-box" id="thumbBox">No Preview</div>
                    <div style="margin-bottom: 10px;"><strong>File:</strong> <span id="fileName">-</span></div>
                    <button class="btn" onclick="downloadTXT()">Download Report</button>
                    <button class="btn" onclick="location.reload()">Reset Tool</button>
                </div>
            </div>
            <div class="data-panel">
                <div style="overflow-x: auto;">
                    <table id="metaTable"></table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. RESILIENT LOADER SYSTEM ---
        const logArea = document.getElementById('loadLogs');
        
        function log(msg, color='#fff') {
            const div = document.createElement('div');
            div.className = 'log-line';
            div.style.color = color;
            div.innerText = "> " + msg;
            logArea.appendChild(div);
        }

        // List of redundant CDNs for every library
        const libraries = [
            {
                name: "ExifReader",
                check: () => typeof window.ExifReader !== 'undefined',
                sources: [
                    "https://cdn.jsdelivr.net/npm/exifreader@4.23.0/dist/exif-reader.min.js",
                    "https://unpkg.com/exifreader@4.23.0/dist/exif-reader.min.js",
                    "https://cdnjs.cloudflare.com/ajax/libs/exifreader/4.12.0/exif-reader.min.js" // Older fallback
                ]
            },
            {
                name: "jsPDF",
                check: () => typeof window.jspdf !== 'undefined',
                sources: [
                    "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
                    "https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"
                ]
            },
            {
                name: "AutoTable",
                check: () => typeof window.jspdf !== 'undefined' && typeof window.jspdf.plugin !== 'undefined', // Loose check
                sources: [
                    "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js",
                    "https://unpkg.com/jspdf-autotable@3.5.29/dist/jspdf.plugin.autotable.min.js"
                ]
            }
        ];

        async function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function initSystem() {
            log("Starting Network Bypass Sequence...");
            
            for (const lib of libraries) {
                let loaded = false;
                for (const source of lib.sources) {
                    if (lib.check()) { loaded = true; break; } // Already loaded
                    
                    try {
                        log(`Attempting to load ${lib.name} from source...`, '#ccc');
                        await loadScript(source);
                        if(lib.check()) {
                            log(`âœ“ Success: ${lib.name} loaded.`, '#4ade80');
                            loaded = true;
                            break; 
                        }
                    } catch (e) {
                        log(`x Blocked: ${source}`, '#f87171');
                    }
                }
                
                if (!loaded) {
                    log(`CRITICAL: Failed to load ${lib.name} from all mirrors.`, 'red');
                }
            }

            // Final Check
            if (typeof window.ExifReader !== 'undefined') {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('systemStatus').classList.add('ok');
                    document.getElementById('systemText').innerText = "System Ready";
                }, 1000);
            } else {
                log("FATAL ERROR: Core engine missing. Check internet.", 'red');
                document.getElementById('forceStartBtn').style.display = 'block';
            }
        }

        // Start Loading immediately
        initSystem();

        document.getElementById('forceStartBtn').onclick = () => {
            document.getElementById('loadingOverlay').style.display = 'none';
        }


        // --- 2. TOOL LOGIC ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        let currentFile = null;
        let allTags = {};

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; };
        dropZone.ondragleave = () => dropZone.style.borderColor = 'var(--border)';
        dropZone.ondrop = e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };
        fileInput.onchange = e => handleFile(e.target.files[0]);

        async function handleFile(file) {
            if(!file) return;
            currentFile = file;

            // UI Setup
            document.getElementById('dashboard').style.display = 'flex';
            dropZone.style.display = 'none';
            document.getElementById('fileName').innerText = file.name;
            const table = document.getElementById('metaTable');
            table.innerHTML = '<tr><td colspan="2">Analyzing...</td></tr>';

            try {
                // Check if engine exists
                if (typeof window.ExifReader === 'undefined') {
                    throw new Error("ExifReader engine is missing. Reload page.");
                }

                const tags = await ExifReader.load(file, { expanded: true });
                allTags = tags;
                renderTable(tags);
                renderThumb(tags);

            } catch (err) {
                console.error(err);
                table.innerHTML = `<tr><td colspan="2" style="color:red">Error: ${err.message}</td></tr>`;
            }
        }

        function renderTable(tags) {
            const table = document.getElementById('metaTable');
            table.innerHTML = '';
            
            const groups = Object.keys(tags).sort();
            if(groups.length === 0) {
                table.innerHTML = '<tr><td colspan="2">No Metadata Found</td></tr>'; return;
            }

            groups.forEach(group => {
                if(group === 'thumbnail') return;
                
                const h = document.createElement('tr');
                h.className = 'group-header';
                h.innerHTML = `<th colspan="2">${group}</th>`;
                table.appendChild(h);

                for(let key in tags[group]) {
                    let val = tags[group][key].description || tags[group][key].value;
                    if(Array.isArray(val)) val = val.join(', ');
                    
                    // Simple clean up
                    val = String(val).substring(0, 300); 

                    const row = document.createElement('tr');
                    row.innerHTML = `<th>${key}</th><td>${val}</td>`;
                    table.appendChild(row);
                }
            });
        }

        function renderThumb(tags) {
            const box = document.getElementById('thumbBox');
            box.innerHTML = '';
            if(tags.thumbnail) {
                const img = document.createElement('img');
                img.src = tags.thumbnail;
                box.appendChild(img);
            } else if (currentFile.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(currentFile);
                box.appendChild(img);
            } else {
                box.innerText = "No Preview";
            }
        }

        function downloadTXT() {
            if(!currentFile) return;
            let txt = `METADATA REPORT: ${currentFile.name}\n\n`;
            for(let g in allTags) {
                if(g==='thumbnail') continue;
                txt += `[${g}]\n`;
                for(let k in allTags[g]) {
                    let v = allTags[g][k].description || allTags[g][k].value;
                    txt += `${k}: ${v}\n`;
                }
                txt += '\n';
            }
            const blob = new Blob([txt], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'report.txt';
            a.click();
        }
    </script>
</body>
</html>
